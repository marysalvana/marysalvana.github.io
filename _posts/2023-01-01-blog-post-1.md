---
title: 'How To Do Spatial Data Analysis in R'
excerpt: "" 
date: 2023-01-01
permalink: /posts/2023/01/blog-post-1/
tags:
  - spatial
  - data analysis
  - R
---

Download spatial dataset from this link: <a href="https://drive.google.com/file/d/162DlIuJjLcx8-md34ywfll47wk0ucA4G/view?usp=sharing" rel="noopener" target="_blank" >Argo dataset</a>. An RData file called `jan_march_residuals.RData` will be downloaded and typically saved in the Downloads folder and can be moved to another directory for the subsequent spatial data analysis.

Spatial data analysis is performed on the RStudio console. A step-by-step procedure is given below with the corresponding screen outputs. The source codes are given at the end.

1. **Open RStudio.**
<figure>
    <img src="/images/how_to_do_spatial_analysis/1_open_rstudio.png" width="20px" height="10px">
</figure>

{:start="2"}
2. **Load spatial dataset.**
<figure>
    <img src="/images/how_to_do_spatial_analysis/2_load_spatial_dataset.png" width="20px" height="10px">
</figure>

{:start="3"}
3. **Get familiar with the spatial dataset.** The 5 most relevant data in the Argo dataset are `profPresAggr`,`profPsalAggr`, `profTempAggr`, `profLatAggr`, and `profLongAggr`. 
 * `profPresAggr` is a list with 243,352 elements. Each element represents the pressure measurements recorded by one Argo float as it ascends from 2000 meters back to the surface. 
 * `profPsalAggr` is a list with 243,352 elements. Each element represents the salinity measurements recorded by one Argo float as it ascends from 2000 meters back to the surface. 
 * `profTempAggr` is a list with 243,352 elements. Each element represents the temperature measurements recorded by one Argo float as it ascends from 2000 meters back to the surface.
 * `profLatAggr` is a vector with 243,352 elements. Each element represents the position of the Argo float in latitude when it made the recording.
 * `profLongAggr` is a vector with 243,352 elements. Each element represents the position of the Argo float in longitude when it made the recording.
<figure>
    <img src="/images/how_to_do_spatial_analysis/3_get_familiar.png" width="20px" height="10px">
</figure>

{:start="4"}
4. **Data Visualization.** Depending on what you want to see from the data, you can produce different types of plots. 

* Plotting the locations where Argo floats were deployed:
<figure>
    <img src="/images/how_to_do_spatial_analysis/4_plotting_argo_float_locations.png" width="20px" height="10px">
</figure>

* Plotting the temperature and salinity measurements recorded by Argo float #100000:
<figure>
    <img src="/images/how_to_do_spatial_analysis/5_plotting_temperature_salinity_single_argo_float.png" width="20px" height="10px">
</figure>

* Plotting the heatmap of temperature measurements closest to the surface:
<figure>
    <img src="/images/how_to_do_spatial_analysis/6_plotting_surface_map_temperature.png" width="20px" height="10px">
</figure>

* Plotting the heatmap of salinity measurements closest to the surface:
<figure>
    <img src="/images/how_to_do_spatial_analysis/7_plotting_surface_map_salinity.png" width="20px" height="10px">
</figure>

{:start="5"}
5. **Check Gaussianity.** 

* Pick a reference location. For example, (latitude, longitude)=(40, -175).

* Extract the measurements from all the Argo floats inside a 900 kilometer radius drawn around the reference location. Download the supplementary R functions to help extract subsets of Argo floats from this link: <a href="https://drive.google.com/file/d/1uV0AhYYM0wJoRhnvIL-7YOoCXybwz72s/view?usp=sharing" rel="noopener" target="_blank" >Supplementary R Functions</a>. An R file called `get_profile_data_subset.R` will be downloaded and typically saved in the Downloads folder. Load the R functions into the R session and get the measurements around (latitude, longitude)=(40, -175).
<figure>
    <img src="/images/how_to_do_spatial_analysis/8_get_profile_data_subset.png" width="20px" height="10px">
</figure>

* Examine the empirical distribution of the temperature measurements.
<figure>
    <img src="/images/how_to_do_spatial_analysis/9_empirical_distribution_temperature_histogram.png" width="20px" height="10px">
    <img src="/images/how_to_do_spatial_analysis/10_empirical_distribution_temperature_qqplot.png" width="20px" height="10px">
</figure>

* Examine the empirical distribution of the salinity measurements.
<figure>
    <img src="/images/how_to_do_spatial_analysis/11_empirical_distribution_salinity_histogram.png" width="20px" height="10px">
    <img src="/images/how_to_do_spatial_analysis/12_empirical_distribution_salinity_qqplot.png" width="20px" height="10px">
</figure>

Exercise: Check Gaussianity at other locations: (latitude, longitude)=(0, -175), (latitude, longitude)=(-40, -175), (latitude, longitude)=(40, -30), (latitude, longitude)=(0, -30), and (latitude, longitude)=(-40, -30).

{:start="6"}
6. **Complete Source Code.** 

```{r}
load('/Users/laisalvana/Downloads/jan_march_residuals.RData')
View(profPresAggr)
plot(profLongAggr, profLatAggr, pch = 20, cex = 0.2, lwd = 0.2, xlab = 'Longitude (degrees)', ylab = 'Latitude (degrees)')
par(mfrow = c(1, 2))
plot(profTempAggr[[100000]][[1]], profPresAggr[[100000]][[1]], type = 'l', ylim = c(2000, 0), xlab = 'Temperature (degrees)', ylab = 'Pressure (decibars)')
plot(profPsalAggr[[100000]][[1]], profPresAggr[[100000]][[1]], type = 'l', ylim = c(2000, 0), xlab = 'Salinity (PSU)', ylab = 'Pressure (decibars)')

install.packages('ggplot2')
library(ggplot2)

relevant_indices <- which(profJulFracofYearAggr > 31 & profJulFracofYearAggr < 60) 
lat <- profLatAggr[relevant_indices]
long <- profLongAggr[relevant_indices]
long_p <- ifelse(long > 180, long - 360, long)
data_at_surface <- sapply(profTempAggr[relevant_indices], function(x) x[[1]][1])

ggplot() + geom_polygon(data = map_data('world'), aes(x = long, y =lat, group = group), fill = 'white', color = 'black', linewidth = .2) + geom_point(data = data.frame(lat, long_p, data_at_surface), aes(x = long_p, y = lat, color = data_at_surface), size = .005, shape = 20) + labs(color ='Surface temperature (Â°C)', x = 'Longitude', y = 'Latitude') + scale_color_gradientn(colours = colorRamps::matlab.like(10), limits = c(-1, 1))  + theme_bw() + theme(panel.background = element_blank(), panel.grid = element_blank(), legend.position = 'top', legend.title = element_text(size = 13), plot.title = element_text(hjust = 0.5, size = 14, face = 'bold.italic'))

data_at_surface <- sapply(profPsalAggr[relevant_indices], function(x) x[[1]][1])
ggplot() + geom_polygon(data = map_data('world'), aes(x = long, y =lat, group = group), fill = 'white', color = 'black', linewidth = .2) + geom_point(data = data.frame(lat, long_p, data_at_surface), aes(x = long_p, y = lat, color = data_at_surface), size = .005, shape = 20) + labs(color ='Surface salinity (PSU)', x = 'Longitude', y = 'Latitude') + scale_color_gradientn(colours = colorRamps::matlab.like(10), limits = c(-0.5, 0.5))  + theme_bw() + theme(panel.background = element_blank(), panel.grid = element_blank(), legend.position = 'top', legend.title = element_text(size = 13), plot.title = element_text(hjust = 0.5, size = 14, face = 'bold.italic'))

source('/Users/laisalvana/Downloads/get_profile_data_subset.R')

#TRY THESE REFERENCE LOCATION PAIRS
#ref_lat <- c(40, 0, -40, 40, 0, -40)
#ref_long <- c(-175, -175, -175, -30, -30, -30)

RADIUS <- 900
REFERENCE_LATITUDE <- 40
REFERENCE_LONGITUDE <- -175

df <- get_profile_data_subset(long = REFERENCE_LONGITUDE, lat = REFERENCE_LATITUDE, day = 45.25, h_time = 45.25, RG_def = FALSE, h_space = RADIUS, mode = 'all',  min_prof = 5, exclusion = TRUE)
head(df)

dev.off()

par(mfrow = c(1, 3))
hist(df$temperature[which(df$pressure <= 100)], main = 'Reference Location 1', xlab = 'Temperature')
mtext('0 to 100 meters', side = 3, col = 'blue')
hist(df$temperature[which(df$pressure > 100 & df$pressure <= 1000)], main = 'Reference Location 1', xlab = 'Temperature')
mtext('100 to 1000 meters', side = 3, col = 'blue')
hist(df$temperature[which(df$pressure > 1000 & df$pressure <= 2000)], main = 'Reference Location 1', xlab = 'Temperature')
mtext('1000 to 2000 meters', side = 3, col = 'blue')

par(mfrow = c(1, 3))
qqnorm(df$temperature[which(df$pressure <= 100)], main = 'Reference Location 1')
qqline(df$temperature[which(df$pressure <= 100)])
mtext('0 to 100 meters', side = 3, col = 'blue')
qqnorm(df$temperature[which(df$pressure > 100 & df$pressure <= 1000)], main = 'Reference Location 1')
qqline(df$temperature[which(df$pressure > 100 & df$pressure <= 1000)])
mtext('100 to 1000 meters', side = 3, col = 'blue')
qqnorm(df$temperature[which(df$pressure > 1000 & df$pressure <= 2000)], main = 'Reference Location 1')
qqline(df$temperature[which(df$pressure > 1000 & df$pressure <= 2000)])
mtext('1000 to 2000 meters', side = 3, col = 'blue')

par(mfrow = c(1, 3))
hist(df$salinity[which(df$pressure <= 100)], main = 'Reference Location 1', xlab = 'Salinity')
mtext('0 to 100 meters', side = 3, col = 'blue')
hist(df$salinity[which(df$pressure > 100 & df$pressure <= 1000)], main = 'Reference Location 1', xlab = 'Salinity')
mtext('100 to 1000 meters', side = 3, col = 'blue')
hist(df$salinity[which(df$pressure > 1000 & df$pressure <= 2000)], main = 'Reference Location 1', xlab = 'Salinity')
mtext('1000 to 2000 meters', side = 3, col = 'blue')

par(mfrow = c(1, 3))
qqnorm(df$salinity[which(df$pressure <= 100)], main = 'Reference Location 1')
qqline(df$salinity[which(df$pressure <= 100)])
mtext('0 to 100 meters', side = 3, col = 'blue')
qqnorm(df$salinity[which(df$pressure > 100 & df$pressure <= 1000)], main = 'Reference Location 1')
qqline(df$salinity[which(df$pressure > 100 & df$pressure <= 1000)])
mtext('100 to 1000 meters', side = 3, col = 'blue')
qqnorm(df$salinity[which(df$pressure > 1000 & df$pressure <= 2000)], main = 'Reference Location 1')
qqline(df$salinity[which(df$pressure > 1000 & df$pressure <= 2000)])
mtext('1000 to 2000 meters', side = 3, col = 'blue')
```
